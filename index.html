<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Generative Circle Pattern Pro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* UPDATED: Added Anton font */
        @import url('https://fonts.googleapis.com/css2?family=Anton&family=Roboto:wght@300;400;700&display=swap');
        
        body {
            font-family: 'Roboto', sans-serif;
            background-color: #0f172a; 
            color: #e2e8f0;
        }

        /* Custom class for the title font */
        .font-anton {
            font-family: 'Anton', sans-serif;
        }

        /* Custom range slider styling */
        input[type=range] {
            -webkit-appearance: none;
            background: transparent;
        }
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none;
            height: 16px;
            width: 16px;
            border-radius: 50%;
            background: #FC4F4F;
            cursor: pointer;
            margin-top: -6px;
            box-shadow: 0 0 10px rgba(252, 79, 79, 0.5);
        }
        input[type=range]::-webkit-slider-runnable-track {
            width: 100%;
            height: 4px;
            cursor: pointer;
            background: rgba(252, 79, 79, 0.3);
            border-radius: 2px;
        }
        
        /* Custom Color Picker wrapper */
        .color-wrapper input[type="color"] {
            -webkit-appearance: none;
            border: none;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            cursor: pointer;
            padding: 0;
            overflow: hidden;
            background: none;
        }
        .color-wrapper input[type="color"]::-webkit-color-swatch-wrapper {
            padding: 0;
        }
        .color-wrapper input[type="color"]::-webkit-color-swatch {
            border: 2px solid #e2e8f0;
            border-radius: 50%;
        }

        /* UPDATED: Solid background color matching bg-gray-50 (#f9fafb), removed checkerboard */
        .canvas-container {
            background-color: #f9fafb; 
        }
        
        /* Details summary marker styling */
        details > summary {
            list-style: none;
        }
        details > summary::-webkit-details-marker {
            display: none;
        }
    </style>
</head>
<body class="h-screen flex flex-col md:flex-row overflow-hidden">

    <!-- Sidebar Controls -->
    <!-- UPDATED: Added order-2 for mobile, md:order-1 for desktop. Changed border logic for mobile/desktop separation. Added flex-1 for mobile scroll. -->
    <div class="w-full md:w-80 bg-[#FFFFFF] md:border-r border-t md:border-t-0 border-gray-200 p-6 flex flex-col gap-5 overflow-y-auto z-10 shadow-xl text-black order-2 md:order-1 flex-1 md:flex-none">
        
        <!-- Header with Logo -->
        <div class="flex items-center gap-3 shrink-0">
            <!-- UPDATED: SVG Logo with fill-rule="evenodd" to fix filled inner parts -->
            <svg width="60" height="60" viewBox="0 0 60 60" fill="none" xmlns="http://www.w3.org/2000/svg" class="shrink-0">
                <path fill-rule="evenodd" clip-rule="evenodd" d="M57.6436 18.323C56.1329 14.7506 53.9693 11.5425 51.2148 8.78725C48.4596 6.03205 45.2515 3.86922 41.6791 2.35844C37.9791 0.793544 34.0503 0 30.0007 0C25.9511 0 22.0222 0.793545 18.323 2.35774C14.7506 3.86853 11.5425 6.03205 8.78725 8.78656C6.03205 11.5418 3.86922 14.7499 2.35844 18.3223C0.793544 22.0222 0 25.9511 0 30.0007C0 34.0503 0.793545 37.9791 2.35774 41.6784C3.86853 45.2508 6.03205 48.4589 8.78656 51.2141C11.5418 53.9693 14.7499 56.1322 18.3223 57.643C22.0215 59.2078 25.9504 60.0007 30 60.0007C34.0496 60.0007 37.9785 59.2071 41.6777 57.643C45.2501 56.1322 48.4582 53.9686 51.2134 51.2141C53.9686 48.4589 56.1315 45.2508 57.6423 41.6784C59.2072 37.9791 60 34.0503 60 30.0007C60 25.9511 59.2065 22.0222 57.6423 18.323H57.6436ZM55.8013 40.8994C54.3911 44.2339 52.3718 47.2284 49.8005 49.7998C47.2284 52.3718 44.2339 54.3904 40.8994 55.8013C37.4478 57.2614 33.7811 58.0016 30.0007 58.0016C26.2203 58.0016 22.5536 57.2614 19.1019 55.8013C15.7675 54.3911 12.773 52.3718 10.2009 49.7998C7.62885 47.2277 5.6103 44.2332 4.2001 40.8994C2.74064 37.4478 1.99981 33.7811 1.99981 30.0007C1.99981 26.2203 2.73995 22.5536 4.2001 19.1019C5.6103 15.7675 7.62954 12.773 10.2009 10.2016C12.773 7.62954 15.7675 5.611 19.1019 4.2001C22.5536 2.73995 26.2203 1.99981 30.0007 1.99981C33.7811 1.99981 37.4478 2.73995 40.8994 4.2001C44.2339 5.6103 47.2284 7.62954 49.8005 10.2016C52.3725 12.7737 54.3911 15.7682 55.8013 19.1019C57.2607 22.5536 58.0016 26.2203 58.0016 30.0007C58.0016 33.7811 57.2614 37.4478 55.8013 40.8994Z" fill="#FC4F4F"/>
                <path fill-rule="evenodd" clip-rule="evenodd" d="M19.3052 30.0007C19.3052 24.1157 24.0928 19.3281 29.9778 19.3281C35.8628 19.3281 40.6504 24.1157 40.6504 30.0007C40.6504 34.472 37.8862 38.3086 33.9774 39.8943V42.0259C39.0113 40.3473 42.6509 35.5916 42.6509 30.0014C42.6509 23.0135 36.9664 17.329 29.9785 17.329C22.9906 17.329 17.3061 23.0135 17.3061 30.0014C17.3061 35.5784 20.9283 40.3251 25.9428 42.0141V39.8798C22.0528 38.285 19.3059 34.4581 19.3059 30.0014L19.3052 30.0007Z" fill="#FC4F4F"/>
                <path fill-rule="evenodd" clip-rule="evenodd" d="M29.9889 8.66451C24.2898 8.66451 18.9313 10.8842 14.9019 14.9137C10.8717 18.9438 8.65273 24.3016 8.65273 30.0007C8.65273 35.6998 10.8724 41.0583 14.9019 45.0878C18.9313 49.1172 24.2898 51.3369 29.9889 51.3369C35.688 51.3369 41.0465 49.1172 45.076 45.0878C49.1055 41.0583 51.3252 35.6998 51.3252 30.0007C51.3252 24.3016 49.1055 18.9431 45.076 14.9137C41.0458 10.8835 35.688 8.66451 29.9889 8.66451ZM43.6623 43.6734C40.228 47.1077 35.7297 49.0902 30.9108 49.3149L30.9379 33.8741C32.7719 33.4052 34.0676 31.6815 33.9331 29.7253C33.7812 27.5216 31.8715 25.8575 29.6678 26.0094C27.464 26.1613 25.7999 28.071 25.9519 30.2747C26.0746 32.0602 27.3517 33.4912 29.0046 33.8894L28.9776 49.3101C24.1927 49.0652 19.7291 47.0855 16.3169 43.6727C12.6648 40.0206 10.6532 35.165 10.6532 30C10.6532 24.8351 12.6648 19.9795 16.3169 16.3273C19.9691 12.6752 24.8247 10.6636 29.9896 10.6636C35.1546 10.6636 40.0102 12.6752 43.6623 16.3273C47.3144 19.9795 49.326 24.8351 49.326 30C49.326 35.165 47.3144 40.0206 43.6623 43.6727V43.6734Z" fill="#FC4F4F"/>
            </svg>

            <div>
                <h1 class="text-2xl font-anton uppercase text-[#FC4F4F] mb-1 tracking-wide leading-none">
                    Circle Gen
                </h1>
                <p class="text-xs text-[#000000]">Halftone Image Processor</p>
            </div>
        </div>

        <!-- Upload Section -->
        <div class="p-4 border border-dashed border-gray-300 rounded-lg hover:border-[#FC4F4F] transition-colors bg-gray-50 shrink-0">
            <label class="block text-sm font-medium text-[#000000] mb-2">Upload Image</label>
            <input type="file" id="imageInput" accept="image/*" class="block w-full text-sm text-gray-600
              file:mr-4 file:py-2 file:px-4
              file:rounded-full file:border-0
              file:text-xs file:font-semibold
              file:bg-[#FC4F4F] file:text-white
              hover:file:bg-red-600
              cursor-pointer
            "/>
        </div>

        <!-- Reset Button -->
        <div class="shrink-0">
            <!-- UPDATED: Added rounded-full for pill shape -->
            <button id="resetBtn" class="w-full text-xs text-gray-500 hover:text-black border border-gray-300 hover:border-black rounded-full py-2 transition-colors">
                Revert to default settings
            </button>
        </div>

        <!-- Canvas Size (Moved to top, above Contrast) -->
        <div class="shrink-0">
            <label class="block text-sm font-medium text-[#000000] mb-2">Canvas Size</label>
            <!-- UPDATED: Custom select styling to match advanced settings chevron -->
            <div class="relative">
                <select id="sizeSelect" class="w-full appearance-none bg-gray-50 text-[#000000] text-sm rounded-lg p-3 pr-10 border border-gray-200 focus:border-[#FC4F4F] outline-none cursor-pointer hover:bg-gray-100 transition-colors">
                    <option value="1920x1080" selected>Landscape (1920 x 1080)</option>
                    <option value="1080x1920">Portrait (1080 x 1920)</option>
                    <option value="2160x2160">Square (2160 x 2160)</option>
                </select>
                <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-3 text-black">
                     <svg fill="none" height="20" shape-rendering="geometricPrecision" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" viewBox="0 0 24 24" width="20"><path d="M6 9l6 6 6-6"></path></svg>
                </div>
            </div>
        </div>

        <!-- Contrast Slider -->
        <div class="shrink-0">
            <div class="flex justify-between mb-1">
                <label class="text-sm font-medium text-[#000000]">Contrast</label>
                <span id="contrastValue" class="text-xs text-[#FC4F4F] font-mono">1.3</span>
            </div>
            <input type="range" id="contrastSlider" min="0.5" max="3" value="1.3" step="0.1" class="w-full">
        </div>

        <!-- Advanced Settings Foldout -->
        <details class="group border border-gray-200 rounded-lg bg-gray-50 shrink-0">
            <summary class="flex justify-between items-center font-medium cursor-pointer list-none p-3 text-sm text-[#000000] hover:bg-gray-100 transition-colors select-none">
                <span>Advanced Settings</span>
                <span class="transition transform group-open:rotate-180">
                    <svg fill="none" height="20" shape-rendering="geometricPrecision" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" viewBox="0 0 24 24" width="20"><path d="M6 9l6 6 6-6"></path></svg>
                </span>
            </summary>
            <div class="p-4 space-y-5 border-t border-gray-200">
                
                <!-- Color Controls -->
                <div class="grid grid-cols-2 gap-4">
                    <!-- UPDATED: bg-gray-50 border border-gray-200 to match container, removed bold from label -->
                    <div class="bg-gray-50 border border-gray-200 p-3 rounded-lg flex flex-col items-center">
                        <label class="text-xs text-[#000000] mb-2">Line Color</label>
                        <!-- UPDATED: Added flex-col to stack items vertically -->
                        <div class="flex flex-col items-center gap-2 w-full">
                            <div class="color-wrapper hover:scale-110 transition-transform">
                                <input type="color" id="lineColorInput" value="#FC4F4F">
                            </div>
                            <input type="text" id="lineColorText" value="#FC4F4F" class="w-20 bg-transparent text-xs text-[#000000] font-mono border-b border-gray-300 focus:border-[#FC4F4F] outline-none text-center pb-1 uppercase">
                        </div>
                    </div>
                    <!-- UPDATED: bg-gray-50 border border-gray-200 to match container, removed bold from label -->
                    <div class="bg-gray-50 border border-gray-200 p-3 rounded-lg flex flex-col items-center">
                        <label class="text-xs text-[#000000] mb-2">Background</label>
                        <!-- UPDATED: Added flex-col to stack items vertically -->
                        <div class="flex flex-col items-center gap-2 w-full">
                            <div class="color-wrapper hover:scale-110 transition-transform">
                                <input type="color" id="bgColorInput" value="#ffffff">
                            </div>
                            <input type="text" id="bgColorText" value="#ffffff" class="w-20 bg-transparent text-xs text-[#000000] font-mono border-b border-gray-300 focus:border-[#FC4F4F] outline-none text-center pb-1 uppercase">
                        </div>
                    </div>
                </div>

                <!-- Sliders -->
                <div>
                    <div class="flex justify-between mb-1">
                        <label class="text-sm font-medium text-[#000000]">Circle Density</label>
                        <span id="gapValue" class="text-xs text-[#FC4F4F] font-mono">13px</span>
                    </div>
                    <input type="range" id="gapSlider" min="4" max="50" value="13" step="1" class="w-full">
                </div>

                <div>
                    <div class="flex justify-between mb-1">
                        <label class="text-sm font-medium text-[#000000]">Max Thickness</label>
                        <span id="thickValue" class="text-xs text-[#FC4F4F] font-mono">13px</span>
                    </div>
                    <input type="range" id="thicknessSlider" min="1" max="30" value="13" step="0.5" class="w-full">
                </div>

                <div>
                    <div class="flex justify-between mb-1">
                        <label class="text-sm font-medium text-[#000000]">Min Thickness</label>
                        <span id="thinValue" class="text-xs text-[#FC4F4F] font-mono">0.1px</span>
                    </div>
                    <input type="range" id="minThicknessSlider" min="0.1" max="10" value="0.1" step="0.1" class="w-full">
                </div>
                
                <!-- Invert Toggle -->
                <div class="flex items-center justify-between pt-2">
                     <label class="relative inline-flex items-center cursor-pointer">
                        <input type="checkbox" id="invertLogic" class="sr-only peer">
                        <div class="w-9 h-5 bg-gray-300 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-4 after:w-4 after:transition-all peer-checked:bg-[#FC4F4F]"></div>
                        <span class="ml-2 text-sm text-[#000000]">Invert Logic</span>
                    </label>
                </div>

                <!-- File Type Select (Moved here) -->
                <div>
                    <label class="text-sm font-medium text-[#000000] mb-2 block">File Format</label>
                    <select id="formatSelect" class="w-full bg-white text-[#000000] text-sm rounded p-2 border border-gray-300 outline-none focus:border-[#FC4F4F]">
                        <option value="webp" selected>WebP Image</option>
                        <option value="png">PNG Image</option>
                    </select>
                </div>

            </div>
        </details>

        <!-- Export Settings (Just Download Button now) -->
        <!-- UPDATED: Increased space-y-4 to space-y-8 to double the gap below the button -->
        <div class="mt-auto pt-6 pb-4 border-t border-gray-200 space-y-8 shrink-0">
            <!-- Download Button -->
            <!-- UPDATED: Added rounded-full for pill shape -->
            <button id="downloadBtn" class="w-full bg-[#FC4F4F] hover:bg-red-600 text-white font-bold py-3 px-4 rounded-full shadow-lg shadow-red-500/20 transition-all transform hover:scale-[1.02]">
                Download
            </button>

            <!-- Momkai Footer -->
            <div class="flex justify-center">
                <a href="https://momkai.com/" target="_blank" class="flex items-center gap-2 text-xs text-gray-500 hover:text-black transition-colors no-underline group">
                    <!-- UPDATED: Added Momkai SVG, sized to match text, using fill-current for hover effect -->
                    <svg viewBox="0 0 40 40" fill="none" xmlns="http://www.w3.org/2000/svg" class="w-4 h-4 fill-current">
                        <path d="M11.4679 0L0 11.4699V0H11.4679Z"/>
                        <path d="M28.5967 0L0 28.5975V17.1669L17.1709 0H28.5967Z"/>
                        <path d="M39.9999 40H28.5404L39.9999 28.5385V40Z"/>
                        <path d="M40.001 22.8415L22.8469 39.9999H11.4184L40.001 11.4081V22.8415Z"/>
                        <path d="M39.9999 0V5.71668L5.7199 39.9999H0V34.2889L34.2969 0H39.9999Z"/>
                    </svg>
                    <span>Made by Momkai</span>
                </a>
            </div>
        </div>
    </div>

    <!-- Main Canvas Area -->
    <!-- UPDATED: Switched to relative positioning parent with absolute child for strict sizing. 
         Added order-1 for mobile, h-[320px] fixed height for mobile, flex-1 for desktop. -->
    <div class="h-[320px] shrink-0 md:h-auto md:flex-1 canvas-container relative overflow-hidden min-h-0 min-w-0 order-1 md:order-2">
        <div id="loadingMsg" class="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 text-slate-500 bg-white/90 px-4 py-2 rounded backdrop-blur-sm animate-pulse pointer-events-none z-20 shadow-lg border border-gray-200" style="display:none;">
            Processing...
        </div>
        
        <!-- Wrapper pinned to edges (inset-4 = padding) to force containment -->
        <div class="absolute inset-8 flex items-center justify-center">
            <canvas id="mainCanvas" class="max-w-full max-h-full shadow-2xl rounded-sm block" style="object-fit: contain;"></canvas>
        </div>
    </div>

    <script>
        /**
         * The Engine Room
         */
        const canvas = document.getElementById('mainCanvas');
        const ctx = canvas.getContext('2d');
        const fileInput = document.getElementById('imageInput');
        
        // State variables
        let sourceImage = new Image();
        let imageLoaded = false;
        
        // Helper canvas to read pixel data efficiently
        const bufferCanvas = document.createElement('canvas');
        const bufferCtx = bufferCanvas.getContext('2d');

        // Defaults object for easy resetting
        const defaults = {
            gap: 13,
            maxThickness: 13,
            minThickness: 0.1,
            contrast: 1.3,
            invertLogic: false,
            lineColor: '#FC4F4F',
            bgColor: '#ffffff',
            width: 1920,
            height: 1080,
            format: 'webp',
            sizeLabel: '1920x1080'
        };

        // Configuration (starts with defaults)
        const config = { ...defaults };

        // UI Elements
        const ui = {
            gap: document.getElementById('gapSlider'),
            thick: document.getElementById('thicknessSlider'),
            thin: document.getElementById('minThicknessSlider'),
            contrast: document.getElementById('contrastSlider'),
            invert: document.getElementById('invertLogic'),
            
            lineColor: document.getElementById('lineColorInput'),
            lineColorText: document.getElementById('lineColorText'),
            bgColor: document.getElementById('bgColorInput'),
            bgColorText: document.getElementById('bgColorText'),
            
            size: document.getElementById('sizeSelect'),
            format: document.getElementById('formatSelect'),
            
            download: document.getElementById('downloadBtn'),
            reset: document.getElementById('resetBtn'),
            loading: document.getElementById('loadingMsg'),
            
            // Value displays
            gapVal: document.getElementById('gapValue'),
            thickVal: document.getElementById('thickValue'),
            thinVal: document.getElementById('thinValue'),
            contrastVal: document.getElementById('contrastValue')
        };

        // Initialize
        function init() {
            updateCanvasSize();
            // drawPlaceholder is called inside updateCanvasSize
        }

        function updateCanvasSize() {
            // Check if ui.size.value contains 'x' or is just a preset key
            const val = ui.size.value;
            if(val.includes('x')) {
                const [w, h] = val.split('x').map(Number);
                config.width = w;
                config.height = h;
            }
            
            canvas.width = config.width;
            canvas.height = config.height;
            
            // Redraw immediately if image exists, otherwise placeholder
            if (imageLoaded) render();
            else drawPlaceholder();
        }

        function resetToDefaults() {
            // Reset config
            Object.assign(config, defaults);
            
            // Reset UI Slider Values
            ui.gap.value = config.gap;
            ui.thick.value = config.maxThickness;
            ui.thin.value = config.minThickness;
            ui.contrast.value = config.contrast;
            ui.invert.checked = config.invertLogic;
            
            // Reset Labels
            ui.gapVal.textContent = config.gap + 'px';
            ui.thickVal.textContent = config.maxThickness + 'px';
            ui.thinVal.textContent = config.minThickness + 'px';
            ui.contrastVal.textContent = config.contrast;
            
            // Reset Colors
            ui.lineColor.value = config.lineColor;
            ui.lineColorText.value = config.lineColor;
            ui.bgColor.value = config.bgColor;
            ui.bgColorText.value = config.bgColor;
            
            // Reset Dropdowns
            ui.size.value = config.sizeLabel;
            ui.format.value = config.format;
            
            // Trigger update
            updateCanvasSize();
        }

        function drawPlaceholder() {
            ctx.fillStyle = config.bgColor;
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            const centerX = canvas.width / 2;
            const centerY = canvas.height / 2;
            // Calculate max radius to cover the furthest corner
            const maxRadius = Math.sqrt(Math.pow(Math.max(centerX, canvas.width-centerX), 2) + Math.pow(Math.max(centerY, canvas.height-centerY), 2));

            ctx.lineCap = 'round';
            ctx.strokeStyle = config.lineColor;
            
            const step = parseInt(config.gap);

            // Start closer to center (step / 2) to reduce hole size
            for (let r = step / 2; r < maxRadius; r += step) {
                ctx.beginPath();
                // Close the loop by going slightly past 2PI
                for (let angle = 0; angle <= Math.PI * 2 + 0.1; angle += 0.05) {
                    const x = centerX + Math.cos(angle) * r;
                    const y = centerY + Math.sin(angle) * r;
                    
                    const dist = Math.sqrt((x-centerX)**2 + (y-centerY)**2);
                    const wave = Math.sin(dist * 0.02) * Math.cos(angle * 5);
                    const thickness = map(wave, -1, 1, parseFloat(config.minThickness), parseFloat(config.maxThickness));
                    
                    ctx.lineWidth = thickness;
                    if (angle === 0) ctx.moveTo(x, y);
                    else ctx.lineTo(x, y);
                    
                    ctx.stroke();
                    ctx.beginPath();
                    ctx.moveTo(x, y);
                }
            }
        }

        function render() {
            if (!imageLoaded) return;
            
            ui.loading.style.display = 'block';
            ui.loading.textContent = "Rendering Canvas...";

            requestAnimationFrame(() => {
                // 1. Clear & Fill Background
                ctx.fillStyle = config.bgColor;
                ctx.fillRect(0, 0, canvas.width, canvas.height);

                // 2. Setup Line
                ctx.strokeStyle = config.lineColor;
                ctx.lineCap = 'butt';

                const centerX = canvas.width / 2;
                const centerY = canvas.height / 2;
                // Calculate max radius to cover the corners for rectangle
                const maxRadius = Math.sqrt(centerX * centerX + centerY * centerY) * (canvas.width > canvas.height ? (canvas.width/canvas.height) : 1.5); 
                // A simpler robust calculation for maxRadius to corner:
                const realMaxRadius = Math.sqrt(Math.pow(canvas.width/2, 2) + Math.pow(canvas.height/2, 2));


                // 3. Prepare Image Data (Resized to fit canvas)
                bufferCanvas.width = config.width;
                bufferCanvas.height = config.height;
                
                // Scale image to 'cover' the canvas (aspect ratio fill)
                const scale = Math.max(config.width / sourceImage.width, config.height / sourceImage.height);
                const x = (config.width / 2) - (sourceImage.width / 2) * scale;
                const y = (config.height / 2) - (sourceImage.height / 2) * scale;
                
                bufferCtx.clearRect(0,0, config.width, config.height);
                bufferCtx.drawImage(sourceImage, x, y, sourceImage.width * scale, sourceImage.height * scale);
                
                const pixelData = bufferCtx.getImageData(0, 0, config.width, config.height).data;

                // 4. Draw Loops
                const step = parseInt(config.gap);
                
                // Start r at step/2 (50% smaller hole)
                for (let r = step / 2; r < realMaxRadius + step; r += step) {
                    ctx.beginPath();
                    
                    const circumference = 2 * Math.PI * r;
                    // Aim for segment length of ~2px for smoothness
                    const angleStep = (Math.PI * 2) / (circumference / 2); 
                    const safeAngleStep = Math.max(angleStep, 0.01); 

                    let firstPoint = true;
                    
                    // Close the loop by going slightly past 2PI
                    for (let angle = 0; angle <= Math.PI * 2 + safeAngleStep; angle += safeAngleStep) {
                        const x = centerX + Math.cos(angle) * r;
                        const y = centerY + Math.sin(angle) * r;

                        // FIX: Removed strict bounds check (continue block) to allow drawing over edges
                        
                        // Clamp coordinates to image bounds for pixel lookup
                        // This prevents errors when x/y go off-canvas, while still allowing the line to be drawn
                        const lookupX = Math.max(0, Math.min(config.width - 1, Math.floor(x)));
                        const lookupY = Math.max(0, Math.min(config.height - 1, Math.floor(y)));

                        // Pixel lookup uses full width
                        const pixelIndex = (lookupY * config.width + lookupX) * 4;
                        const red = pixelData[pixelIndex];
                        const green = pixelData[pixelIndex + 1];
                        const blue = pixelData[pixelIndex + 2];
                        
                        let brightness = (0.299 * red + 0.587 * green + 0.114 * blue) / 255; // 0 (dark) to 1 (light)

                        // Contrast
                        brightness = (brightness - 0.5) * config.contrast + 0.5;
                        brightness = Math.max(0, Math.min(1, brightness));

                        let thickness;
                        if(config.invertLogic) {
                             // Light = Thick
                             thickness = map(brightness, 0, 1, parseFloat(config.minThickness), parseFloat(config.maxThickness));
                        } else {
                             // Dark = Thick
                             thickness = map(brightness, 0, 1, parseFloat(config.maxThickness), parseFloat(config.minThickness));
                        }

                        ctx.lineWidth = thickness;

                        if (firstPoint) {
                            ctx.moveTo(x, y);
                            firstPoint = false;
                        } else {
                            ctx.lineTo(x, y);
                            ctx.stroke();
                            ctx.beginPath();
                            ctx.moveTo(x, y);
                        }
                    }
                }
                
                ui.loading.style.display = 'none';
            });
        }

        function triggerDownload(url, filename) {
            const link = document.createElement('a');
            link.download = filename;
            link.href = url;
            link.click();
        }

        function map(value, low1, high1, low2, high2) {
            return low2 + (high2 - low2) * (value - low1) / (high1 - low1);
        }

        // --- Event Listeners ---

        fileInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (event) => {
                    sourceImage = new Image();
                    sourceImage.onload = () => {
                        imageLoaded = true;
                        render();
                    };
                    sourceImage.src = event.target.result;
                };
                reader.readAsDataURL(file);
            }
        });

        // Config Updates
        const updateConfig = (key, valueElement, isFloat = false) => (e) => {
            config[key] = isFloat ? parseFloat(e.target.value) : parseInt(e.target.value);
            if(valueElement) valueElement.textContent = config[key] + (isFloat ? '' : 'px');
            if (imageLoaded) render(); else drawPlaceholder();
        };

        ui.gap.addEventListener('input', updateConfig('gap', ui.gapVal));
        ui.thick.addEventListener('input', updateConfig('maxThickness', ui.thickVal, true));
        ui.thin.addEventListener('input', updateConfig('minThickness', ui.thinVal, true));
        ui.contrast.addEventListener('input', updateConfig('contrast', ui.contrastVal, true));

        // Sync Color Inputs (Picker <-> Text)
        function updateColor(key, value) {
            config[key] = value;
            if(key === 'lineColor') {
                ui.lineColor.value = value;
                ui.lineColorText.value = value;
            } else {
                ui.bgColor.value = value;
                ui.bgColorText.value = value;
            }
            if (imageLoaded) render(); else drawPlaceholder();
        }

        // Line Color Listeners
        ui.lineColor.addEventListener('input', (e) => updateColor('lineColor', e.target.value));
        ui.lineColorText.addEventListener('input', (e) => updateColor('lineColor', e.target.value));
        ui.lineColorText.addEventListener('change', (e) => {
            // Validate hex on blur/enter
            if(!/^#[0-9A-F]{6}$/i.test(e.target.value)) {
                e.target.value = config.lineColor; // Revert if invalid
            } else {
                updateColor('lineColor', e.target.value);
            }
        });

        // Bg Color Listeners
        ui.bgColor.addEventListener('input', (e) => updateColor('bgColor', e.target.value));
        ui.bgColorText.addEventListener('input', (e) => updateColor('bgColor', e.target.value));
        ui.bgColorText.addEventListener('change', (e) => {
             if(!/^#[0-9A-F]{6}$/i.test(e.target.value)) {
                e.target.value = config.bgColor;
            } else {
                updateColor('bgColor', e.target.value);
            }
        });


        // Invert Logic
        ui.invert.addEventListener('change', (e) => {
            config.invertLogic = e.target.checked;
            if (imageLoaded) render(); else drawPlaceholder();
        });

        // Size
        ui.size.addEventListener('change', (e) => {
            updateCanvasSize();
        });

        // Reset
        ui.reset.addEventListener('click', resetToDefaults);

        // Download Handler
        ui.download.addEventListener('click', () => {
            const format = ui.format.value;
            
            ui.loading.style.display = 'block';
            ui.loading.textContent = "Encoding...";

            // Use setTimeout to allow UI to render the loading message
            setTimeout(() => {
                let url;
                let filename;

                if (format === 'webp') {
                    // WebP export (0.9 quality)
                    url = canvas.toDataURL('image/webp', 0.9);
                    filename = 'circle-pattern-pro.webp';
                } else {
                    url = canvas.toDataURL('image/png');
                    filename = 'circle-pattern-pro.png';
                }
                
                triggerDownload(url, filename);
                ui.loading.style.display = 'none';
            }, 50);
        });

        // Boot
        init();

    </script>
</body>
</html>
